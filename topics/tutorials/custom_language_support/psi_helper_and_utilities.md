<!-- Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license. -->

# 6. PSI Helpers and Utilities

<link-summary>Extending the Simple language PSI classes with the utility and helper methods.</link-summary>

<tldr>

**Code**: [`SimplePsiImplUtil`](%gh-sdk-samples-master%/simple_language_plugin/src/main/java/org/intellij/sdk/language/psi/impl/SimplePsiImplUtil.java),[`SimpleUtil`](%gh-sdk-samples-master%/simple_language_plugin/src/main/java/org/intellij/sdk/language/SimpleUtil.java)

</tldr>

<include from="language_and_filetype.md" element-id="custom_language_tutorial_header"></include>

Helper classes and utilities can be embedded in the code generated by Grammar-Kit.

> Note that due to the [lack of support for two-pass generation](https://github.com/JetBrains/gradle-grammar-kit-plugin/issues/3), extending PSI elements with methods via utils is not supported in [Gradle Grammar-Kit Plugin](tools_gradle_grammar_kit_plugin.md).
>
{style="warning"}

## Define Helper Methods for Generated PSI Elements

Custom methods in [PSI](psi.md) classes are defined separately, and Grammar-Kit embeds them into generated code.
Define a utility class with these helper methods:

```java
package org.intellij.sdk.language.psi.impl;

import com.intellij.lang.ASTNode;
import org.intellij.sdk.language.psi.SimpleProperty;
import org.intellij.sdk.language.psi.SimpleTypes;

public class SimplePsiImplUtil {

  public static String getKey(SimpleProperty element) {
    ASTNode keyNode = element.getNode().findChildByType(SimpleTypes.KEY);
    if (keyNode != null) {
      // IMPORTANT: Convert embedded escaped spaces to simple spaces
      return keyNode.getText().replaceAll("\\\\ ", " ");
    } else {
      return null;
    }
  }

  public static String getValue(SimpleProperty element) {
    ASTNode valueNode = element.getNode().findChildByType(SimpleTypes.VALUE);
    if (valueNode != null) {
      return valueNode.getText();
    } else {
      return null;
    }
  }

}
```

The parser generates the `SimpleProperty` interface referenced in the code above.

## Update Grammar and Regenerate the Parser

Now the utility class is added to the grammar file via the `psiImplUtilClass` global attribute.
Add the `methods` attribute for a particular rule to specify which one should be used for PSI classes.

Compare the `property` rule below to the [previous definition](grammar_and_parser.md#define-the-grammar).

```bnf
{
  parserClass="org.intellij.sdk.language.parser.SimpleParser"

  extends="com.intellij.extapi.psi.ASTWrapperPsiElement"

  psiClassPrefix="Simple"
  psiImplClassSuffix="Impl"
  psiPackage="org.intellij.sdk.language.psi"
  psiImplPackage="org.intellij.sdk.language.psi.impl"

  elementTypeHolderClass="org.intellij.sdk.language.psi.SimpleTypes"
  elementTypeClass="org.intellij.sdk.language.psi.SimpleElementType"
  tokenTypeClass="org.intellij.sdk.language.psi.SimpleTokenType"

  psiImplUtilClass="org.intellij.sdk.language.psi.impl.SimplePsiImplUtil"
}

simpleFile ::= item_*

private item_ ::= (property|COMMENT|CRLF)

property ::= (KEY? SEPARATOR VALUE?) | KEY
{
  methods=[getKey getValue]
}
```

After including the above changes in the grammar, [regenerate](grammar_and_parser.md#generate-a-parser) the parser and PSI classes.

## Define a Utility to Search Properties

Create [`SimpleUtil`](%gh-sdk-samples-master%/simple_language_plugin/src/main/java/org/intellij/sdk/language/SimpleUtil.java) utility class to search PSI elements for defined properties over the project.
It will be used later when implementing [code completion](completion_contributor.md).

```java
```
{src="simple_language_plugin/src/main/java/org/intellij/sdk/language/SimpleUtil.java" include-symbol="SimpleUtil"}
